# 32.最长有效括号

https://leetcode.cn/problems/longest-valid-parentheses/description/?envType=study-plan-v2&envId=top-100-liked

```java
class Solution {
    /**
    dp[n] - 以下标n为结尾的最长有效括号
    dp[n] = Math.max(dp[i-2]+2,dp[i-dp[i-1]-1] + dp[i-1]+2)
     */
    public int longestValidParentheses(String s) {
        char[] arr = s.toCharArray();
        int[] dp = new int[arr.length];
        int result = 0;
        if(arr.length <2){
            return result;
        }
        if(arr[0]=='('&&arr[1]==')'){
            dp[1] = 2;
            result = 2;
        }
        
        for(int i = 2;i<arr.length;i++){
            if(arr[i] == ')'){
                // dp[i] = Math.max(dp[i-2]+2,dp[i-dp[i-1]-2] + dp[i-1]+2);
                /**
                情况1.')'前面是'('，则dp[i] = dp[i-2]+2
                情况2.')'前面是')',则以当前i结尾，需要在i-dp[i-1]-1位置是'('才能满足条件
                 */
                if(arr[i-1]=='('){
                    dp[i] = dp[i-2]+2;
                }else{
                    //此情况如 （ .... )( ( ......))
                    int pre = i - dp[i - 1] - 1;
                    if(pre >=0 && arr[pre]=='('){
                        dp[i] = dp[i-1]+2;
                        if(pre-1>=0){
                            dp[i] = dp[i] + dp[pre-1];
                        }
                    }
                }
                result = Math.max(result,dp[i]);
            }
        }
        return result;
    }
}
```

题目要求连续最长有效括号，因此状态转移依赖结尾元素，因此可以定义``dp[n] - 以下标n为结尾的最长有效括号``, 对于'('结尾的，不构成有效括号，所以dp[i]直接等于0，而对于')'结尾的会有两种情况：1.i-1位置是'('，所以dp[i] = dp[i-2]+2 ; 2.i-1位置是')'，因此前一个元素已经处在dp[i-1]的有效括号中，我们需要找到索引 ``i-dp[i-1]-1``处的元素，如果该元素为')'，那么不构成有效括号，dp[i]=0;如果为'('，那么情况就如同``（ .... ) ( ( ......))``,dp = dp[i-dp[i-1]-2] + dp[i-1]+2)